---
title: "TP2-Prog"
format: html
editor: visual
---

# Introducción

En este trabajo realizaremos un análisis exploratorio de datos provistos por el Servicio Meteorológico Nacional. Los datos son diarios, los archivos por día indican año, mes y día. Exploramos distintas categorías y variables como: Fecha, hora, Temperatura, humedad, pnm ( presión al nivel Del Mar), dd( dirección del viento), fuerza del viento y nombre del aeropuerto.

Nuestro objetivo del trabajo consiste:

\- Combinar los datos dados en un único dataset

\- Importar y limpiar datos

\- Realizar análisis estadístico y descriptivo

\- Visualizar variables en gráficos

\- Manejar los valores nulos, faltantes o duplicados

Entre otras consignas e ideas que vayamos aplicado a lo largo del trabajo.

## Primeras Visualizaciones

### Muestra de datos y resumen

Cargamos el dataset y visualizamos las primeras 10 filas

```{r}

df <- readRDS("C://Users//anapa//OneDrive//Escritorio//facu//progii//TP-Prog-2//dataset_smn.rds")
df$Precipitacion. <- as.numeric(df$Precipitacion.)
head(df)
```

Ahora nos damos una idea general del tipo de datos que posee cada columna y los valores aproximados que toman.

```{r}
summary(df)

```

Transformamos a factor las columnas que los requieran

```{r}
library(dplyr)
columnas_factor <- c("NOMBRE","Provincia","Nro")

df <- df %>%
  mutate_at(columnas_factor, .funs = factor)
```

### Manejo de NAs y datos atipicos

Debido a que la mayoria de los valores que toma la columna PNM, correspondientes a la presión atmósferica, se encuentran en un rango increiblemente atipico para nuestro planeta

```{r}
df$PNM <- NULL
```

Ahora nos encargamos de eliminar los datos nulos de nuestro dataset

```{r}
library(dplyr)
library(tidyr)
df <- drop_na(df)
summary(df)
```

Filtramos los valores de la columna DD, direccion del viento, para quedarnos con aquellos menores a 360

```{r}
df <- df %>% filter(DD<=360)
```

# EDA

### Analisis univariado

```{r}
# Load the required package
library(plotly)

# Create the interactive plot with dropdown
fig <- plot_ly(df, type = 'histogram') %>%
  layout(
    updatemenus = list(
      list(
        buttons = list(
          list(method = "restyle",
               args = list("x", list(df$TEMP)),
               label = "Temperatura"),
          list(method = "restyle",
               args = list("x", list(df$HUM)),
               label = "Humedad"),
          list(method = "restyle",
               args = list("x", list(df$FF)),
               label = "Fuerza del Viento"),
          list(method = "restyle",
               args = list("x", list(df$Altura)),
               label = "Altura"),
          list(method = "restyle",
               args = list("x", list(df$Precipitacion.)),
               label = "Precipitacion")
        ),
        direction = "down",
        x = 0.1,
        xanchor = "left",
        y = 1.2,
        yanchor = "top"
      )
    )
  )
#fig
```

Vemos cuantas ocurrencias unicas de estaciones y provincias tenemos, y a su vez que provincias y estaciones poseen mas registros.

```{r}
library(dplyr)

n_distinct(df$NOMBRE)
n_distinct(df$Provincia)

df %>% count(NOMBRE) %>% arrange(desc(n))
df %>% count(Provincia) %>% arrange(desc(n))

```

Analizamos la cantidad de registros que existen para cada uno de los dias y graficos los resultados en un line plot usando ggplot2

```{r}
registros_diarios <- df %>%
  group_by(FECHA) %>%
  summarise(Registros = n())

```

```{r}
library(ggplot2)

# Plot the daily counts
ggplot(registros_diarios, aes(x = FECHA, y = Registros)) +
  geom_line(color = "cornflowerblue") +
  labs(title = "Cantidad de registros por dia",
       x = "Fecha",
       y = "Registros") +
  theme_minimal()

```

Buscamos esos dias con valores maximos y minimos, y el promedio de registros por dia.

```{r}
summary(registros_diarios)
```

```{r}
max_re <- registros_diarios %>% filter(Registros == max(Registros))
min_re <- registros_diarios %>% filter(Registros == min(Registros))
max_re
min_re
```

Realizamos un gráfico de 10 estaciones con mayor promedio de Temperatura

```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(plotly)

promedio_TEMP <- df %>%
  group_by(NOMBRE) %>%
  summarise(promedio_TEMP = mean(TEMP, na.rm = TRUE))
promedio_TEMP

top_10 <- promedio_TEMP[order(-promedio_TEMP$promedio_TEMP), ][1:10, ]

top_10


grafico_aero_temp = ggplot(top_10, aes(x = promedio_TEMP, y = reorder(NOMBRE, promedio_TEMP))) +
  geom_bar(stat = "identity", fill = "lightcoral") +
  labs(x = "Temperatura Promedio", y = "Estaciones",) + ggtitle("Top 10 estaciones con mayor promedio de Temperatura") +
  theme(plot.title = element_text(size = 10)) +
  theme_minimal() +
  theme(axis.text.y = element_text(hjust = 1))
grafico_aero_temp
```

Distribución de humedad por estación

```{r}
p2 <- ggplot(df, aes(x = Estacion, y = HUM, fill = Estacion)) +
  geom_boxplot() +
  labs(title = "Distribución de humedad por estación", x = "Estación", y = "Humedad") +
  theme_minimal()
p2
```

### Analisis Multivariado

Ploteamos una matriz de correlacion para buscar relaciones entre las variables numericas de nuestro dataset

En esta matriz podemos apreciar que, mientras que niguna variable exhibe una fuerte correlación con otras, sí existen ciertas con una correlación cercana a 0.5 como Latitud y Temperatura (las Temperaturas más calidas con más comunes al norte que al sur del país), Longitud con Temperatura y Humedad (las zonas cercanas a la costa atlantica tienden a presentar más humedad), Latitud y Altura, u Hora y Temperatura (son más comunes las altas Temperatura en ciertos momentos del día)

```{r}
library(reshape2) # Para reestructurar datos para ggplot

#Seleccionar solo las columnas numéricas
numeric_df <- df %>% select_if(is.numeric)

#Calcular la matriz de correlación
cor_matrix <- cor(numeric_df, use = "complete.obs")

# Reestructurar la matriz de correlación para ggplot2
cor_melted <- melt(cor_matrix)

# Graficar el mapa de calor
ggplot(cor_melted, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name="Correlación") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(title = "Matriz de Correlación", x = "Variables", y = "Variables")

```

```{r}
# 
# Definimos una funcion que indique la estacion en base a la fecha
get_estacion <- function(fecha) {
  # Nos quedamos solo con dia y mes
  mes <- as.integer(format(fecha, "%m"))
  dia <- as.integer(format(fecha, "%d"))
  
  # determinamos la estacion en base a estos datos
  if ((mes == 12 && dia >= 21) || mes %in% c(1, 2) || (mes == 3 && dia <= 20)) {
    return("Verano")
  } else if ((mes == 3 && dia >= 21) || mes %in% c(4, 5) || (mes == 6 && dia <= 20)) {
    return("Otoño")
  } else if ((mes == 6 && dia >= 21) || mes %in% c(7, 8) || (mes == 9 && dia <= 20)) {
    return("Invierno")
  } else {
    return("Primavera")
  }
}

# Lo aplicamos al dataset
df$Estacion <- sapply(df$FECHA, get_estacion)

# Lo pasamos de character a factor
df$Estacion <- as.factor(df$Estacion)

#Visualizamos
summary(df$Estacion)
```

Creamos tambien una variable Amplitud, que denota la amplitud termica alcanzada cada dia.

```{r}
library(dplyr)

# Función para calcular amplitud térmica diaria
calcular_amplitud_termica <- function(df) {
  df <- df %>%
    
    # Agrupar por día y estación
    group_by(FECHA, NOMBRE) %>%
    
    # Calcular la amplitud térmica diaria
    summarize(AmplitudTermica = max(TEMP) - min(TEMP), .groups = 'drop') %>%
    
    # Unir la amplitud térmica calculada de vuelta a cada registro horario original
    right_join(df, by = c("FECHA", "NOMBRE"))
  
  return(df)
}

# Aplicar la función al dataset
df <- calcular_amplitud_termica(df)

df$AmplitudTermica <- as.numeric(df$AmplitudTermica)

```

Distribución amplitud térmica

```{r}
library(ggplot2)
library(scales)

p1_at <- ggplot(df, aes(x = AmplitudTermica)) +
  geom_histogram(binwidth = 1, fill = "deeppink", color = "grey", alpha = 0.7) +
  labs(title = "Histograma De Amplitud Termica", x = "Amplitud Termica", y = "Frequency") +
  theme_minimal()
p1_at

```

Vemos la Temperatura promedio por estación del año

```{r}
library(ggplot2)

promedio_estaciones = df %>%
  group_by(Estacion)%>%
  summarise(promedio_estacion_temp = mean(TEMP, na.rm = TRUE))

grafico_estacion_temp = ggplot(promedio_estaciones, aes(x= Estacion, y= promedio_estacion_temp)) + geom_bar(fill= "lightcoral",stat = "identity")  + 
  labs(title="Temperatura promedio por estación", 
       y="Estación") + 
  theme_minimal()
grafico_estacion_temp
```

Amplitud térmica promedio por estación

```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(plotly)
promedio_amplitud <- df %>%
  group_by(NOMBRE) %>%
  summarise(promedio_amplitud = mean(AmplitudTermica, na.rm = TRUE))
promedio_amplitud

top_10 <- promedio_amplitud[order(-promedio_amplitud$promedio_amplitud), ][1:10, ]

top_10


grafico_amplitud = ggplot(top_10, aes(x = promedio_amplitud, y = reorder(NOMBRE, promedio_amplitud))) +
  geom_bar(stat = "identity", fill = "darkcyan") +
  labs(x = "Amplitud Promedio", y = "Estaciones",) + ggtitle("Top 10 estaciones con mayor promedio de Amplitud") +
  theme(plot.title = element_text(size = 10)) +
  theme_minimal() +
  theme(axis.text.y = element_text(hjust = 1))
grafico_amplitud

```

Distribución de Temperatura por estación

```{r}
library(ggplot2)
library(dplyr)

p1 <- ggplot(df, aes(x = Estacion, y = TEMP, fill = Estacion)) +
  geom_boxplot() +
  labs(title = "Distribución de Temperatura por estación", x = "Estación", y = "Temperatura") +
  theme_minimal()
p1
```

Distribución de humedad por estación

```{r}
p2 <- ggplot(df, aes(x = Estacion, y = HUM, fill = Estacion)) +
  geom_boxplot() +
  labs(title = "Distribución de humedad por estación", x = "Estación", y = "Humedad") +
  theme_minimal()
p2
```

Precipitaciones promedio por estacion

```{r}
p5 <- df %>%
  group_by(Estacion) %>%
  summarise(promedio_precipitacion = mean(Precipitacion., na.rm = TRUE)) %>%
  filter(!is.na(promedio_precipitacion)) %>%
  ggplot(aes(x = Estacion, y = promedio_precipitacion, fill = Estacion)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(
    y = "Promedio Precipitaciones",
    title = "Promedio de precipitaciones por Estacion"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for better readability

p5
```

Scatter plot Temperatura vs humedad:

El gráfico `p3` es un diagrama de dispersión de Temperatura vs Humedad, con puntos coloreados por la `estación` . Este gráfico es útil para visualizar la relación entre la Temperatura y la humedad en diferentes estaciones. Al colorear los puntos según la temporada, se puede observar cualquier patrón o tendencia estacional en los datos. Por ejemplo, que determinadas estaciones tienen Temperaturas más altas y humedad más baja, o viceversa. Este tipo de visualización ayuda a comprender cómo estas dos variables interactúan y varían con los cambios estacionales.

```{r}
library(ggplot2)
library(dplyr)
p3 <- ggplot(df, aes(x = TEMP, y = HUM, color = Estacion)) +
  geom_point(alpha = 0.6) +
  labs(title = "Scatter plot de Temperatura vs Humedad", x = "Temperatura", y = "Humedad") +
  theme_minimal()
p3
```


# Analisis Espacial

En esta seccion llevaremos s cabo un analisis espacial del dataset, valiendonos de los datos geograficos de cada estacion y de la libreria leaflet.

## Mapa de Temperatura y precipitaciones 

Aqui utilizaremos celdas de Voronoi para mejor representar el area alcanzada por cada estacion meteorologica. Estas celdas unen cada punto del mapa con su estacion mas cercana, creando asi poligonos alrededor de cada una de las estaciones.

```{r}
library(dplyr)
library(deldir)
library(ggplot2)

# Extraemos los promedios de temperatura y precipitaciones
avg_data <- df %>%
  group_by(NOMBRE, Latitud, Longitud) %>%
  summarise(avg_temperature = mean(TEMP, na.rm = TRUE),
            avg_precipitation = mean(Precipitacion., na.rm = TRUE))

# Definimos las celdas de voronoi
voronoi <- deldir(avg_data$Longitud, avg_data$Latitud)

# Extraemos las celdas de Voronoi
voronoi_tiles <- data.frame(
  x = voronoi$d$dirsgs[, c(1, 3)],  # las coordenadas de los segmentos
  y = voronoi$d$dirsgs[, c(2, 4)]
)

# Convertimos las coordenadas en un dataframe
voronoi_tiles <- data.frame(
  x = c(voronoi_tiles$x[,1], voronoi_tiles$y[,1]),
  y = c(voronoi_tiles$x[,2], voronoi_tiles$y[,2])
)

# Crear el gráfico con ggplot
ggplot() +
  geom_polygon(data = voronoi_tiles, aes(x = x, y = y, group = interaction(x, y)), fill = "lightblue", color = "black") +
  geom_point(data = avg_data, aes(x = Longitud, y = Latitud, color = avg_temperature), size = 2) +
  scale_color_viridis_c() +
  theme_minimal() +
  labs(title = "Voronoi tessellation of temperatures")

```


## Mapa Diario

Este mapa busca representar la evolucion de las diferentes variables climaticas a lo largo de un dia elegido al azar, este tipo de graficos es usado a menudo para radares meteorologicos y seguimiento de temporales.

Un ejemplo es el uso de radaras meteorologicos de seguimiento de precipitaciones en Formula 1, para agilizar la estrategia del equipo y piloto en base al movimiento de frentes de lluvia y tormentas alrededor del circuito.

```{r}
library(shiny)
library(leaflet)
library(dplyr)
library(sf)
library(leaflet.extras)

# Seleccionar un día aleatorio en el que haya llovia en alguna estación
set.seed(123)
df_dia_lluvioso <- df %>%
  filter(Precipitacion. > 0) %>%
  select(FECHA) %>%
  distinct() %>%
  sample_n(1)

dia_seleccionado <- df_dia_lluvioso$FECHA[1]
datos_dia <- df %>%
  filter(as.Date(FECHA) == dia_seleccionado)

# UI de Shiny
ui <- fluidPage(
  titlePanel("Mapa de Estaciones Meteorológicas con Capas por Variable"),

  sidebarLayout(
    sidebarPanel(
      sliderInput("hora", "Selecciona la Hora:",
                  min = 0, max = 23, value = 12, step = 1, round = 0,
                  sep = "", animate = TRUE),
      checkboxGroupInput("layers", "Selecciona Capas a Mostrar:",
                         choices = list("Temperatura" = "temp",
                                        "Lluvia" = "rain",
                                        "Dirección del Viento" = "wind"),
                         selected = c("temp", "rain", "wind"))
    ),

    mainPanel(
      leafletOutput("mapa")
    )
  )
)

# Servidor de Shiny
server <- function(input, output, session) {
  datos_filtrados <- reactive({
    datos_dia %>% filter(HORA == input$hora)
  })

  output$mapa <- renderLeaflet({
    leaflet() %>%
      addProviderTiles(providers$OpenStreetMap) %>%
      setView(lng = mean(datos_dia$Longitud), lat = mean(datos_dia$Latitud), zoom = 6)
  })

  observe({
    data <- datos_filtrados()

    leafletProxy("mapa", data = data) %>%
      clearMarkers() %>%
      clearShapes()

    # Capa de Temperatura
    if ("temp" %in% input$layers) {
      leafletProxy("mapa", data = data) %>%
        addCircleMarkers(
          ~Longitud, ~Latitud,
          color = ~colorNumeric("RdYlGn", TEMP, reverse = TRUE)(TEMP),
          radius = 5,
          group = "Temperatura",
          popup = ~paste(
            "<b>Estación:</b>", NOMBRE, "<br>",
            "<b>Temperatura:</b>", TEMP, "°C", "<br>",
            "<b>Lluvia:</b>", Precipitacion., "mm", "<br>",
            "<b>Fuerza del viento:</b>", FF, "km/h", "<br>",
            "<b>Dirección del viento:</b>", DD, "°"
          )
        )
    }

    # Capa de Lluvia
    if ("rain" %in% input$layers) {
      leafletProxy("mapa", data = data) %>%
        addCircleMarkers(
          ~Longitud, ~Latitud,
          color = ~colorNumeric("Blues", Precipitacion.)(Precipitacion.),
          radius = 5,
          group = "Lluvia",
          popup = ~paste(
            "<b>Estación:</b>", NOMBRE, "<br>",
            "<b>Temperatura:</b>", TEMP, "°C", "<br>",
            "<b>Lluvia:</b>", Precipitacion., "mm", "<br>",
            "<b>Fuerza del viento:</b>", FF, "km/h", "<br>",
            "<b>Dirección del viento:</b>", DD, "°"
          )
        )
    }

    # Agregar controles de capas
    leafletProxy("mapa") %>%
      addLayersControl(
        overlayGroups = c("Temperatura", "Lluvia"),
        options = layersControlOptions(collapsed = FALSE)
      )
  })
}

# Ejecutar la aplicación
shinyApp(ui, server)

```

En este caso los colores van de verde (Temperaturas bajas) a rojo (Temperaturas altas), y en caso de precipitaciones, de gris (sin precipitaciones) a azul (fuertes precipitaciones). Cada circulo es una estacion distintas y al hacer click en esta podemos ver las condiciones climaticas para esa estacion en la hora del dia que hayamos seleccionado, ademas de ver de que estacion se trata. Las capas pueden ocultarse para focalizar el analisis en una variables en especifico

## Mapa de calentamiento

En este mapa podemos visualizar como evoluciona la Temperatura promedio por estación y mes, para el periodo de tiempo con el que estamos trabajando, esto puede ayudra a visualizar fenomenos climaticos como olas de calor o frentes de frio polar.

```{r}
library(shiny)
library(leaflet)
library(dplyr)
library(lubridate)

# Cargar tus datos (asegúrate de que el DataFrame 'df' contenga tus datos)
# df <- read.csv("tu_archivo.csv")  # Descomenta y ajusta según sea necesario

# Comprobación de datos
if (any(is.na(df$TEMP))) {
  stop("Hay valores NA en la columna de Temperatura.")
}

if (any(is.na(df$FECHA))) {
  stop("Hay valores NA en la columna de fechas.")
}


# Calcular la Temperatura promedio por mes y año
df$year_month <- floor_date(df$FECHA, "month")
temp_promedio <- df %>%
  group_by(year_month, Latitud, Longitud, NOMBRE) %>%
  summarise(average_temp = mean(TEMP, na.rm = TRUE), .groups = 'drop')

# Comprobación de si temp_promedio tiene datos
if (nrow(temp_promedio) == 0) {
  stop("No hay datos disponibles para mostrar.")
}

# UI de Shiny
ui <- fluidPage(
  titlePanel("Temperatura Promedio por Mes y Año"),
  
  sidebarLayout(
    sidebarPanel(
      sliderInput("year_month", "Selecciona el Mes y Año:",
                  min = min(temp_promedio$year_month, na.rm = TRUE),
                  max = max(temp_promedio$year_month, na.rm = TRUE),
                  value = min(temp_promedio$year_month, na.rm = TRUE),
                  timeFormat = "%Y-%m",
                  animate = TRUE)
    ),
    
    mainPanel(
      leafletOutput("mapa")
    )
  )
)

# Servidor de Shiny
server <- function(input, output, session) {
  output$mapa <- renderLeaflet({
    leaflet() %>%
      addProviderTiles(providers$OpenStreetMap) %>%
      setView(lng = -64, lat = -38, zoom = 4)  # Ajusta la vista inicial
  })

  observe({
    datos_filtrados <- temp_promedio %>%
      filter(year_month == input$year_month)

    if (nrow(datos_filtrados) > 0) {
      leafletProxy("mapa", data = datos_filtrados) %>%
        clearMarkers() %>%
        clearControls() %>%
        addCircleMarkers(
          ~Longitud, ~Latitud,
          radius = 6,
          color = ~colorNumeric("RdYlBu", average_temp, reverse = TRUE)(average_temp),
          fillOpacity = 0.7,
          popup = ~paste("Estación:", NOMBRE, "<br>",
                         "Temperatura Promedio:", round(average_temp, 2), "°C")
        ) %>%
        addLegend(pal = colorNumeric("RdYlBu", NULL, reverse = TRUE), values = ~average_temp,
                  position = "bottomright", title = "Temperatura Promedio (°C)")
    }
  })
}

# Ejecutar la aplicación
shinyApp(ui, server)

```
